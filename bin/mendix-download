#!/bin/bash

VERSION="$1"
WITH_MXBUILD="$2"
MXBUILD_URL="https://cdn.mendix.com/runtime/mxbuild-${VERSION}.tar.gz"
RUNTIME_URL="https://cdn.mendix.com/runtime/mendix-${VERSION}.tar.gz"

if [ "$WITH_MXBUILD" = "with-mxbuild" ]; then
    mkdir -p /srv/mendix/build
    echo "Downloading mxbuild from $MXBUILD_URL"
    curl -SL "$MXBUILD_URL" | tar -zxC /srv/mendix/build

    # Setup mono
    apt install -y apt-transport-https dirmngr gnupg ca-certificates
    apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 3FA7E0328081BFF6A14DA29AA6A19B38D3D831EF
    # Use stable-stretch/snapshots/5.20.1 instead of stable-stretch to pin to older version; default to latest
    echo "deb https://download.mono-project.com/repo/debian stable-stretch main" | tee /etc/apt/sources.list.d/mono-official-stable.list
    apt update
    # mono-runtime is not enough apparently
    apt install -y mono-devel openjdk-11-jdk
fi

runtime_target_dir="/srv/mendix/runtimes/$VERSION"
if [ ! -d "$runtime_target_dir" ]; then
    echo "Downloading runtime from $RUNTIME_URL"
    curl -SL "$RUNTIME_URL" | tar -zxC /srv/mendix/runtimes
fi
